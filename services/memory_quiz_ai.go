package services

import (
	"couple-app/models" // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Models ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Struct QuizQuestion
	"encoding/json"     // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á JSON
	"fmt"               // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
	"regexp"            // ‡πÉ‡∏ä‡πâ Regular Expression ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á JSON ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏¢‡∏∞
	"strings"           // ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ String
	"time"              // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Sleep) ‡∏ï‡∏≠‡∏ô Retry
)

// GenerateQuizFromMemory: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥" ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Quiz"
func GenerateQuizFromMemory(memoryContent string) (*models.QuizQuestion, error) {
	// üöÄ SUPER PROMPT: ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡∏°‡∏´‡∏≤‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
	// Prompt ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏π‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡πâ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å
	prompt := fmt.Sprintf(`
    [SYSTEM ROLE] ‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠ "‡∏°‡∏´‡∏≤‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å" ‡∏ú‡∏π‡πâ‡∏Ñ‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    [INPUT DATA] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏à‡∏£‡∏¥‡∏á: "%s"

    [CRITICAL TASK] ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° JSON 1 ‡∏Ç‡πâ‡∏≠ ‡∏ï‡∏≤‡∏°‡∏Å‡∏é "‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏∑‡∏î‡∏ä‡∏∑‡∏î" ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
    1. **‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Event First)**: ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏û.‡∏®., ‡∏Ñ.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏µ" ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å, ‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á, ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏≤‡∏á (‡πÅ‡∏≠‡∏õ), ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á (‡πÄ‡∏ä‡πà‡∏ô 21:09)" 
    2. **‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°**: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÜ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    3. **‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°**: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏û‡∏µ‡πà‡∏û‡∏µ", "‡∏ô‡πâ‡∏≠‡∏á‡∏£‡∏™‡∏î‡∏µ", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏π‡∏£‡∏™‡∏î‡∏µ" ‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô
    4. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢**: ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÜ ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏≥‡∏û‡∏π‡∏î, ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡πâ‡∏ô
    5. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á**: ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å [INPUT DATA] 100%% ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏á

    [JSON FORMAT]
    {
      "question": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏¢‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏µ)",
      "options": ["‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≠‡∏Å 1", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≠‡∏Å 2", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≠‡∏Å 3"],
      "answer_index": 0,
      "sweet_comment": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ü‡∏ô‡∏ô‡∏∂‡∏Å‡∏ñ‡∏∂‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡πâ‡∏ô"
    }
    **Return ONLY JSON. No Markdown.**`, memoryContent)

	var rawResponse string

	// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö Retry 2 ‡∏£‡∏≠‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô AI ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö (Rate Limit) ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
	for i := 0; i < 2; i++ {
		rawResponse = AskGroqCustom(prompt, 600) // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏¥‡∏á AI (‡πÉ‡∏ô package ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
		if strings.TrimSpace(rawResponse) != "" {
			break // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
		}
		time.Sleep(500 * time.Millisecond) // ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
	}

	// ‚úÖ ‡∏™‡∏Å‡∏±‡∏î JSON ‡∏î‡πâ‡∏ß‡∏¢ Regex (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
	// AI ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏ä‡∏≠‡∏ö‡∏ï‡∏≠‡∏ö‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡∏ô‡∏≥‡∏°‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô "Here is your JSON..." ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà {...}
	re := regexp.MustCompile(`(?s)\{.*\}`)
	cleanJSON := re.FindString(rawResponse)

	// üõ°Ô∏è SMART FALLBACK: ‡∏ñ‡πâ‡∏≤ AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ Regex ‡∏´‡∏≤ JSON ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
	// ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Manual ("‡∏à‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏ô‡∏∞...") ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ User ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ Error ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß
	if strings.TrimSpace(cleanJSON) == "" {
		fmt.Printf("‚ö†Ô∏è AI Timeout, Using Sage Fallback for: %s\n", memoryContent)
		return &models.QuizQuestion{
			Question:     fmt.Sprintf("‡∏à‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏ô‡∏∞: %s?", memoryContent),
			Options:      []string{"‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", "‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏á‡πÜ", "‡∏ô‡∏∂‡∏Å‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∞", "‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤"},
			AnswerIndex:  0, // ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡∏°‡∏≠ (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î")
			SweetComment: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏°‡∏≠ ‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ ‚ú®",
		}, nil
	}

	// ‡πÅ‡∏õ‡∏•‡∏á JSON String ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏õ‡πá‡∏ô Struct ‡∏Ç‡∏≠‡∏á Go
	var quiz models.QuizQuestion
	if err := json.Unmarshal([]byte(cleanJSON), &quiz); err != nil {
		return nil, fmt.Errorf("JSON Parse Error: %v", err)
	}

	return &quiz, nil
}
