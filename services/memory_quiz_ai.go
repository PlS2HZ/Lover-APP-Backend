package services

import (
	"couple-app/models"
	"encoding/json"
	"fmt"
	"regexp"
	"strings"
	"time"
)

func GenerateQuizFromMemory(memoryContent string) (*models.QuizQuestion, error) {
	// üöÄ SUPER PROMPT: ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡∏°‡∏´‡∏≤‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
	prompt := fmt.Sprintf(`
    [SYSTEM ROLE] ‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠ "‡∏°‡∏´‡∏≤‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å" ‡∏ú‡∏π‡πâ‡∏Ñ‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    [INPUT DATA] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏à‡∏£‡∏¥‡∏á: "%s"

    [CRITICAL TASK] ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° JSON 1 ‡∏Ç‡πâ‡∏≠ ‡∏ï‡∏≤‡∏°‡∏Å‡∏é "‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏∑‡∏î‡∏ä‡∏∑‡∏î" ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
    1. **‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Event First)**: ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏û.‡∏®., ‡∏Ñ.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏µ" ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å, ‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á, ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏≤‡∏á (‡πÅ‡∏≠‡∏õ), ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á (‡πÄ‡∏ä‡πà‡∏ô 21:09)" 
    2. **‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°**: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÜ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    3. **‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°**: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏û‡∏µ‡πà‡∏û‡∏µ", "‡∏ô‡πâ‡∏≠‡∏á‡∏£‡∏™‡∏î‡∏µ", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏ô‡∏π‡∏£‡∏™‡∏î‡∏µ" ‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô
    4. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢**: ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÜ ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏≥‡∏û‡∏π‡∏î, ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡πâ‡∏ô
    5. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á**: ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å [INPUT DATA] 100%% ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏á

    [JSON FORMAT]
    {
      "question": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏¢‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏µ)",
      "options": ["‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≠‡∏Å 1", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≠‡∏Å 2", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≠‡∏Å 3"],
      "answer_index": 0,
      "sweet_comment": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ü‡∏ô‡∏ô‡∏∂‡∏Å‡∏ñ‡∏∂‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡πâ‡∏ô"
    }
    **Return ONLY JSON. No Markdown.**`, memoryContent)

	var rawResponse string
	// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö Retry 2 ‡∏£‡∏≠‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô AI ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö (Rate Limit)
	for i := 0; i < 2; i++ {
		rawResponse = AskGroqCustom(prompt, 600)
		if strings.TrimSpace(rawResponse) != "" {
			break
		}
		time.Sleep(500 * time.Millisecond)
	}

	// ‚úÖ ‡∏™‡∏Å‡∏±‡∏î JSON ‡∏î‡πâ‡∏ß‡∏¢ Regex (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢)
	re := regexp.MustCompile(`(?s)\{.*\}`)
	cleanJSON := re.FindString(rawResponse)

	// üõ°Ô∏è SMART FALLBACK: ‡∏ñ‡πâ‡∏≤ AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
	if strings.TrimSpace(cleanJSON) == "" {
		fmt.Printf("‚ö†Ô∏è AI Timeout, Using Sage Fallback for: %s\n", memoryContent)
		return &models.QuizQuestion{
			Question:     fmt.Sprintf("‡∏à‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏ô‡∏∞: %s?", memoryContent),
			Options:      []string{"‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", "‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏á‡πÜ", "‡∏ô‡∏∂‡∏Å‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∞", "‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤"},
			AnswerIndex:  0,
			SweetComment: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏°‡∏≠ ‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ ‚ú®",
		}, nil
	}

	var quiz models.QuizQuestion
	if err := json.Unmarshal([]byte(cleanJSON), &quiz); err != nil {
		return nil, fmt.Errorf("JSON Parse Error: %v", err)
	}

	return &quiz, nil
}
